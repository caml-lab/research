{"title": "Cflow-ad: Real-time unsupervised anomaly detection with localization via conditional normalizing flows", "abstract": "Unsupervised anomaly detection with localization has many practical applications when labeling is infeasible and, moreover, when anomaly examples are completely missing in the train data. While recently proposed models for such data setup achieve high accuracy metrics, their complexity is a limiting factor for real-time processing. In this paper, we propose a real-time model and analytically derive its relationship to prior methods. Our CFLOW-AD model is based on a conditional normalizing flow framework adopted for anomaly detection with localization. In particular, CFLOW-AD consists of a discriminatively pretrained encoder followed by a multi-scale generative decoders where the latter explicitly estimate likelihood of the encoded features. Our approach results in a computationally and memory-efficient model: CFLOW-AD is faster and smaller by a factor of 10x than prior state-of-the-art with the same input setting. Our experiments on the MVTec dataset show that CFLOW-AD outperforms previous methods by 0.36% AUROC in detection task, by 1.12% AUROC and 2.5% AUPRO in localization task, respectively. We open-source our code with fully reproducible experiments.", "authors": ["Denis Gudovskiy", " Shun Ishizaka", " Kazuki Kozuka"], "pdf_url": "https://arxiv.org/abs/2107.12571", "list_table_and_caption": [{"table": "<table><thead><tr><th>Model</th><th>Train</th><th>Test</th><th>Memory</th></tr></thead><tbody><tr><th>SPADE [7]</th><td>{\\mathbb{G}}</td><td>\\sum\\nolimits_{{\\bm{v}}\\in{\\mathbb{G}}}\\|{\\bm{v}}-{\\bm{z}}_{i}\\|_{2}^{2}</td><td>{\\bm{\\lambda}}+{\\mathbb{G}}</td></tr><tr><th>PaDiM [8]</th><td>{\\bm{\\Sigma}}^{-1}_{i}</td><td>M({\\bm{z}}_{i})</td><td>{\\bm{\\lambda}}+{\\bm{\\Sigma}}^{-1}_{i}</td></tr><tr><th>Ours</th><td>\\mathcal{L}({\\bm{\\theta}})</td><td>\\log\\hat{p}_{Z}({\\bm{z}}_{i},{\\bm{c}}_{i},{\\bm{\\theta}})</td><td>{\\bm{\\lambda}}+{\\bm{\\theta}}</td></tr></tbody></table>", "caption": "Table 1: Complexity estimates for SPADE [7], PaDiM [8] and our CFLOW-AD. We compare train and test complexity as well as memory requirements. All models use the same encoder h({\\bm{\\lambda}}) setup, but diverge in the post-processing. SPADE allocates memory for a train gallery {\\mathbb{G}} used in k-nearest-neighbors. PaDiM keeps large matrices ({\\bm{\\Sigma}}^{k}_{i})^{-1},i\\in\\{H_{k}\\times W_{k}\\} for Mahalanobis distance. Our model employs trained decoders g_{k}({\\bm{\\theta}}_{k}) for post-processing.", "list_citation_info": ["[7] Niv Cohen and Yedid Hoshen. Sub-image anomaly detection with deep pyramid correspondences. arXiv:2005.02357v3, 2021.", "[8] Thomas Defard, Aleksandr Setkov, Angelique Loesch, and Romaric Audigier. PaDiM: a patch distribution modeling framework for anomaly detection and localization. In Proceedings of the International Conference on Pattern Recognition (ICPR) Workshops, 2021."]}, {"table": "<table><tbody><tr><td>Encoder</td><td>WRN50</td><td>WRN50</td><td>WRN50</td><td>WRN50</td><td>WRN50</td><td>R18</td><td>R18</td><td>MNetV3</td><td>MNetV3</td></tr><tr><td># of CL</td><td colspan=\"2\">4 \\quad\\longrightarrow\\quad 8</td><td>8</td><td>8</td><td>8</td><td>8</td><td>8</td><td>8</td><td>8</td></tr><tr><td># of PL</td><td>2</td><td colspan=\"2\">2 \\quad\\longrightarrow\\quad 3</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td></tr><tr><td>H\\timesW</td><td>256</td><td>256</td><td colspan=\"2\">256 \\quad\\longrightarrow\\quad 512</td><td>512</td><td colspan=\"2\">256 \\quad\\longrightarrow\\quad 512</td><td colspan=\"2\">256 \\quad\\longrightarrow\\quad 512</td></tr><tr><td>Type</td><td>CFLOW</td><td>CFLOW</td><td>CFLOW</td><td colspan=\"2\">CFLOW \\rightarrow UFLOW</td><td>CFLOW</td><td>CFLOW</td><td>CFLOW</td><td>CFLOW</td></tr><tr><td>Bottle</td><td>97.28\\pm0.03</td><td>97.24\\pm0.03</td><td>98.76\\pm0.01</td><td>98.98\\pm0.01</td><td>98.83\\pm0.01</td><td>98.47\\pm0.03</td><td>98.64\\pm0.01</td><td>98.74</td><td>98.92</td></tr><tr><td>Cable</td><td>95.71\\pm0.01</td><td>96.17\\pm0.07</td><td>97.64\\pm0.04</td><td>97.12\\pm0.06</td><td>95.29\\pm0.04</td><td>96.75\\pm0.04</td><td>96.07\\pm0.06</td><td>97.62</td><td>97.49</td></tr><tr><td>Capsule</td><td>98.17\\pm0.02</td><td>98.19\\pm0.05</td><td>98.98\\pm0.00</td><td>98.64\\pm0.02</td><td>98.40\\pm0.12</td><td>98.62\\pm0.02</td><td>98.28\\pm0.05</td><td>98.89</td><td>98.75</td></tr><tr><td>Carpet</td><td>98.50\\pm0.01</td><td>98.55\\pm0.01</td><td>99.23\\pm0.01</td><td>99.25\\pm0.01</td><td>99.24\\pm0.00</td><td>99.00\\pm0.01</td><td>99.29\\pm0.00</td><td>98.64</td><td>99.00</td></tr><tr><td>Grid</td><td>93.77\\pm0.05</td><td>93.88\\pm0.16</td><td>96.89\\pm0.02</td><td>98.99\\pm0.02</td><td>98.74\\pm0.00</td><td>93.95\\pm0.04</td><td>98.53\\pm0.01</td><td>94.75</td><td>98.81</td></tr><tr><td>Hazelnut</td><td>98.08\\pm0.01</td><td>98.13\\pm0.02</td><td>98.82\\pm0.01</td><td>98.89\\pm0.01</td><td>98.88\\pm0.01</td><td>98.81\\pm0.01</td><td>98.41\\pm0.01</td><td>98.88</td><td>99.00</td></tr><tr><td>Leather</td><td>98.92\\pm0.02</td><td>99.00\\pm0.06</td><td>99.61\\pm0.01</td><td>99.66\\pm0.00</td><td>99.65\\pm0.00</td><td>99.45\\pm0.01</td><td>99.51\\pm0.02</td><td>99.50</td><td>99.64</td></tr><tr><td>Metal Nut</td><td>96.72\\pm0.03</td><td>96.72\\pm0.06</td><td>98.56\\pm0.03</td><td>98.25\\pm0.04</td><td>98.16\\pm0.03</td><td>97.59\\pm0.05</td><td>96.42\\pm0.03</td><td>98.36</td><td>98.78</td></tr><tr><td>Pill</td><td>98.46\\pm0.02</td><td>98.46\\pm0.01</td><td>98.95\\pm0.00</td><td>98.52\\pm0.05</td><td>98.20\\pm0.08</td><td>98.34\\pm0.02</td><td>97.80\\pm0.05</td><td>98.69</td><td>98.44</td></tr><tr><td>Screw</td><td>94.98\\pm0.06</td><td>95.28\\pm0.06</td><td>98.10\\pm0.05</td><td>98.86\\pm0.02</td><td>98.78\\pm0.01</td><td>97.38\\pm0.03</td><td>98.40\\pm0.03</td><td>98.04</td><td>99.09</td></tr><tr><td>Tile</td><td>95.52\\pm0.02</td><td>95.66\\pm0.06</td><td>97.71\\pm0.02</td><td>98.01\\pm0.01</td><td>97.98\\pm0.02</td><td>95.10\\pm0.02</td><td>95.80\\pm0.10</td><td>96.07</td><td>96.48</td></tr><tr><td>Toothbrush</td><td>98.02\\pm0.03</td><td>97.98\\pm0.00</td><td>98.56\\pm0.02</td><td>98.93\\pm0.00</td><td>98.89\\pm0.00</td><td>98.44\\pm0.02</td><td>99.00\\pm0.01</td><td>98.09</td><td>98.80</td></tr><tr><td>Transistor</td><td>93.09\\pm0.28</td><td>94.05\\pm0.11</td><td>93.28\\pm0.40</td><td>80.52\\pm0.13</td><td>76.28\\pm0.14</td><td>92.71\\pm0.23</td><td>83.34\\pm0.46</td><td>97.79</td><td>95.22</td></tr><tr><td>Wood</td><td>90.65\\pm0.10</td><td>90.59\\pm0.07</td><td>94.49\\pm0.03</td><td>96.65\\pm0.01</td><td>96.56\\pm0.02</td><td>93.51\\pm0.03</td><td>95.00\\pm0.04</td><td>92.24</td><td>94.96</td></tr><tr><td>Zipper</td><td>96.80\\pm0.02</td><td>97.01\\pm0.05</td><td>98.41\\pm0.09</td><td>99.08\\pm0.02</td><td>99.06\\pm0.01</td><td>97.71\\pm0.06</td><td>98.98\\pm0.01</td><td>97.50</td><td>99.07</td></tr><tr><td>Average</td><td>96.31</td><td>96.46</td><td>97.87</td><td>97.36</td><td>96.86</td><td>97.06</td><td>96.90</td><td>97.59</td><td>98.16</td></tr></tbody></table>", "caption": "Table 2: Ablation study of CFLOW-AD using localization AUROC metric on the MVTec [4] dataset, %. We experiment with input image resolution (H\\times W), encoder architecture (ResNet-18 (R18), WideResnet-50 (WRN50) and MobileNetV3L (MNetV3)), type of normalizing flow (unconditional (UFLOW) and conditional (CFLOW)), number of coupling (# of CL) and pooling layers (# of PL).", "list_citation_info": ["[4] Paul Bergmann, Michael Fauser, David Sattlegger, and Carsten Steger. MVTec AD \u2013 a comprehensive real-world dataset for unsupervised anomaly detection. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), 2019."]}, {"table": "<table><tbody><tr><td>Task</td><td colspan=\"2\">Localization</td><td colspan=\"4\">Detection</td><td colspan=\"3\">Localization</td></tr><tr><td>Encoder</td><td colspan=\"4\">ResNet-18</td><td>EffNetB4</td><td colspan=\"4\">WideResNet-50</td></tr><tr><td>Class/Model</td><td>CutPaste</td><td>Ours</td><td>CutPaste</td><td>Ours</td><td>CutPaste</td><td>Ours</td><td>SPADE</td><td>PaDiM</td><td>Ours</td></tr><tr><td>Bottle</td><td>97.6</td><td>98.64</td><td>98.3</td><td>100.00</td><td>100.0</td><td>100.0</td><td>(98.4, 95.5)</td><td>(98.3, 94.8)</td><td>(98.98, 96.80)</td></tr><tr><td>Cable</td><td>90.0</td><td>96.75</td><td>80.6</td><td>97.62</td><td>96.2</td><td>97.59</td><td>(97.2, 90.9)</td><td>(96.7, 88.8)</td><td>(97.64, 93.53)</td></tr><tr><td>Capsule</td><td>97.4</td><td>98.62</td><td>96.2</td><td>93.15</td><td>95.4</td><td>97.68</td><td>(99.0, 93.7)</td><td>(98.5, 93.5)</td><td>(98.98, 93.40)</td></tr><tr><td>Carpet</td><td>98.3</td><td>99.29</td><td>93.1</td><td>98.20</td><td>100.0</td><td>98.73</td><td>(97.5, 94.7)</td><td>(99.1, 96.2)</td><td>(99.25, 97.70)</td></tr><tr><td>Grid</td><td>97.5</td><td>98.53</td><td>99.9</td><td>98.97</td><td>99.1</td><td>99.60</td><td>(93.7, 86.7)</td><td>(97.3, 94.6)</td><td>(98.99, 96.08)</td></tr><tr><td>Hazelnut</td><td>97.3</td><td>98.81</td><td>97.3</td><td>99.91</td><td>99.9</td><td>99.98</td><td>(99.1, 95.4)</td><td>(98.2, 92.6)</td><td>(98.89, 96.68)</td></tr><tr><td>Leather</td><td>99.5</td><td>99.51</td><td>100.0</td><td>100.00</td><td>100.0</td><td>100.0</td><td>(97.6, 97.2)</td><td>(98.9, 88.8)</td><td>(99.66, 99.35)</td></tr><tr><td>Metal Nut</td><td>93.1</td><td>97.59</td><td>99.3</td><td>98.45</td><td>98.6</td><td>99.26</td><td>(98.1, 94.4)</td><td>(97.2, 85.6)</td><td>(98.56, 91.65)</td></tr><tr><td>Pill</td><td>95.7</td><td>98.34</td><td>92.4</td><td>93.02</td><td>93.3</td><td>96.82</td><td>(96.5, 94.6)</td><td>(95.7, 92.7)</td><td>(98.95, 95.39)</td></tr><tr><td>Screw</td><td>96.7</td><td>98.40</td><td>86.3</td><td>85.94</td><td>86.6</td><td>91.89</td><td>(98.9, 96.0)</td><td>(98.5, 94.4)</td><td>(98.86, 95.30)</td></tr><tr><td>Tile</td><td>90.5</td><td>95.80</td><td>93.4</td><td>98.40</td><td>99.8</td><td>99.88</td><td>(87.4, 75.9)</td><td>(94.1, 86.0)</td><td>(98.01, 94.34)</td></tr><tr><td>Toothbrush</td><td>98.1</td><td>99.00</td><td>98.3</td><td>99.86</td><td>90.7</td><td>99.65</td><td>(97.9, 93.5)</td><td>(98.8, 93.1)</td><td>(98.93, 95.06)</td></tr><tr><td>Transistor</td><td>93.0</td><td>97.69</td><td>95.5</td><td>93.04</td><td>97.5</td><td>95.21</td><td>(94.1, 87.4)</td><td>(97.5, 84.5)</td><td>(97.99, 81.40)</td></tr><tr><td>Wood</td><td>95.5</td><td>95.00</td><td>98.6</td><td>98.59</td><td>99.8</td><td>99.12</td><td>(88.5, 97.4)</td><td>(94.9, 91.1)</td><td>(96.65, 95.79)</td></tr><tr><td>Zipper</td><td>99.3</td><td>98.98</td><td>99.4</td><td>96.15</td><td>99.9</td><td>98.48</td><td>(96.5, 92.6)</td><td>(98.5, 95.9)</td><td>(99.08, 96.60)</td></tr><tr><td>Average</td><td>96.0</td><td>98.06</td><td>95.2</td><td>96.75</td><td>97.1</td><td>98.26</td><td>(96.0, 91.7)</td><td>(97.5, 92.1)</td><td>(98.62, 94.60)</td></tr></tbody></table>", "caption": "Table 3: The detailed comparison of PaDiM [8], SPADE [7], CutPaste [19] and our CFLOW-AD on the MVTec [4] dataset for every class using AUROC or, if available, a tuple (AUROC, AUPRO) metric, %. CFLOW-AD model is with the best hyperparameters from Section 5.2 ablation study. For fair comparison, we group together results with the same encoder architectures such as ResNet-18 and WideResNet-50.", "list_citation_info": ["[7] Niv Cohen and Yedid Hoshen. Sub-image anomaly detection with deep pyramid correspondences. arXiv:2005.02357v3, 2021.", "[8] Thomas Defard, Aleksandr Setkov, Angelique Loesch, and Romaric Audigier. PaDiM: a patch distribution modeling framework for anomaly detection and localization. In Proceedings of the International Conference on Pattern Recognition (ICPR) Workshops, 2021.", "[4] Paul Bergmann, Michael Fauser, David Sattlegger, and Carsten Steger. MVTec AD \u2013 a comprehensive real-world dataset for unsupervised anomaly detection. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), 2019.", "[19] Chun-Liang Li, Kihyuk Sohn, Jinsung Yoon, and Tomas Pfister. CutPaste: Self-supervised learning for anomaly detection and localization. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), 2021."]}, {"table": "<table><thead><tr><th>Metric</th><th colspan=\"2\">AUROC</th><th>AUPRO</th></tr><tr><th>Model</th><th>Detection</th><th colspan=\"2\">Localization</th></tr></thead><tbody><tr><th>DifferNet [30]</th><th>94.9</th><td>-</td><td>-</td></tr><tr><th>DFR [37]</th><th>-</th><td>95.0</td><td>91.0</td></tr><tr><th>SVDD [42]</th><th>92.1</th><td>95.7</td><td>-</td></tr><tr><th>SPADE [7]</th><th>85.5</th><td>96.0</td><td>91.7</td></tr><tr><th>CutPaste [19]</th><th>97.1</th><td>96.0</td><td>-</td></tr><tr><th>PaDiM [8]</th><th>97.9</th><td>97.5</td><td>92.1</td></tr><tr><th>CFLOW-AD (ours)</th><th>98.26</th><td>98.62</td><td>94.60</td></tr></tbody></table>", "caption": "Table 4: Average AUROC and AUPRO on the MVTec [4] dataset, %. Both the best detection and localization metrics are presented, if available. CFLOW-AD is with WideResNet-50 encoder.", "list_citation_info": ["[37] Yong Shi, Jie Yang, and Zhiquan Qi. Unsupervised anomaly segmentation via deep feature reconstruction. Neurocomputing, 2021.", "[7] Niv Cohen and Yedid Hoshen. Sub-image anomaly detection with deep pyramid correspondences. arXiv:2005.02357v3, 2021.", "[4] Paul Bergmann, Michael Fauser, David Sattlegger, and Carsten Steger. MVTec AD \u2013 a comprehensive real-world dataset for unsupervised anomaly detection. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), 2019.", "[42] Jihun Yi and Sungroh Yoon. Patch SVDD: Patch-level SVDD for anomaly detection and segmentation. In Proceedings of the Asian Conference on Computer Vision (ACCV), 2020.", "[8] Thomas Defard, Aleksandr Setkov, Angelique Loesch, and Romaric Audigier. PaDiM: a patch distribution modeling framework for anomaly detection and localization. In Proceedings of the International Conference on Pattern Recognition (ICPR) Workshops, 2021.", "[30] Marco Rudolph, Bastian Wandt, and Bodo Rosenhahn. Same same but DifferNet: Semi-supervised defect detection with normalizing flows. In Proceedings of the IEEE/CVF Winter Conference on Applications of Computer Vision (WACV), 2021.", "[19] Chun-Liang Li, Kihyuk Sohn, Jinsung Yoon, and Tomas Pfister. CutPaste: Self-supervised learning for anomaly detection and localization. In Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR), 2021."]}, {"table": "<table><thead><tr><th>Metric</th><th colspan=\"2\">AUROC</th></tr><tr><th>Model</th><th>Detection</th><th>Localization</th></tr></thead><tbody><tr><th>CAVGA [40]</th><td>-</td><td>85.0</td></tr><tr><th>SPADE [7]</th><td>71.9</td><td>89.9</td></tr><tr><th>PaDiM [8]</th><td>-</td><td>91.2</td></tr><tr><th>CFLOW-AD (ours)</th><td>72.63</td><td>94.48</td></tr></tbody></table>", "caption": "Table 5: Average AUROC on the STC [22] dataset, %. Both the best available detection and localization metrics are showed. CFLOW-AD is with WideResNet-50 encoder.", "list_citation_info": ["[40] Shashanka Venkataramanan, Kuan-Chuan Peng, Rajat Vikram Singh, and Abhijit Mahalanobis. Attention guided anomaly localization in images. In Proceedings of the European Conference on Computer Vision (ECCV), 2020.", "[7] Niv Cohen and Yedid Hoshen. Sub-image anomaly detection with deep pyramid correspondences. arXiv:2005.02357v3, 2021.", "[8] Thomas Defard, Aleksandr Setkov, Angelique Loesch, and Romaric Audigier. PaDiM: a patch distribution modeling framework for anomaly detection and localization. In Proceedings of the International Conference on Pattern Recognition (ICPR) Workshops, 2021.", "[22] Weixin Luo, Wen Liu, and Shenghua Gao. A revisit of sparse coding based anomaly detection in stacked RNN framework. In Proceedings of the IEEE/CVF International Conference on Computer Vision (ICCV), 2017."]}, {"table": "<table><tbody><tr><td rowspan=\"2\">Complexity metricand Model</td><td rowspan=\"2\">Inferencespeed, fps</td><td colspan=\"2\">Model size, MB</td></tr><tr><td>STC</td><td>MVTec</td></tr><tr><td>R18 encoder only</td><td>80 / 62</td><td colspan=\"2\">45</td></tr><tr><td>PaDiM-R18 [8]</td><td>4.4</td><td>210</td><td>170</td></tr><tr><td>CFLOW-AD-R18</td><td>34 / 12</td><td colspan=\"2\">96</td></tr><tr><td>WRN50 encoder only</td><td>62 / 30</td><td colspan=\"2\">268</td></tr><tr><td>SPADE-WRN50 [7]</td><td>0.1</td><td>37,000</td><td>1,400</td></tr><tr><td>PaDiM-WRN50 [8]</td><td>1.1</td><td>5,200</td><td>3,800</td></tr><tr><td>CFLOW-AD-WRN50</td><td>27 / 9</td><td colspan=\"2\">947</td></tr><tr><td>MNetV3 encoder only</td><td>82 / 61</td><td colspan=\"2\">12</td></tr><tr><td>CFLOW-AD-MNetV3</td><td>35 / 12</td><td colspan=\"2\">25</td></tr></tbody></table>", "caption": "Table 6: Complexity comparison in terms of inference speed (fps) and model size (MB). Inference speed for CFLOW-AD models from Table 3 is measured for (256\\times256) / (512\\times512) inputs.", "list_citation_info": ["[7] Niv Cohen and Yedid Hoshen. Sub-image anomaly detection with deep pyramid correspondences. arXiv:2005.02357v3, 2021.", "[8] Thomas Defard, Aleksandr Setkov, Angelique Loesch, and Romaric Audigier. PaDiM: a patch distribution modeling framework for anomaly detection and localization. In Proceedings of the International Conference on Pattern Recognition (ICPR) Workshops, 2021."]}]}